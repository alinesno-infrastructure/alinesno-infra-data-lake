# 数据湖整体架构图

### 一、中小型架构流程图（TB级离线+1万条/秒实时）

![数据湖架构图](/document/design/lake_01.png) *(注：请将架构图文件放入 `docs/images/` 目录下)*

```mermaid
flowchart LR
    %% 数据来源层
    A1[离线数据源<br/>MySQL/业务库/FTP文件] --> B1[Spark Batch<br/>离线ETL]
    A2[实时数据源<br/>Kafka轻量集群<br/>日志/业务埋点] --> B2[Spark Structured Streaming<br/>实时接入（Exactly-Once）]
    
    %% 计算层（2台机器）
    B1 --> C[Spark Standalone集群<br/>1 Master+1 Worker<br/>流批任务隔离]
    B2 --> C
    C --> D[Iceberg格式处理<br/>小文件自动合并+分区管理]
    
    %% 存储层（3台机器）
    D --> E[MinIO集群<br/>3节点+3副本<br/>热数据存储]
    E --> F[Iceberg Rest Catalog<br/>元数据统一管理（本地+备份）]
    
    %% 数据资产层（1台机器）
    F --> G[PostgreSQL<br/>资产元数据存储<br/>索引优化]
    G --> H[Redis缓存<br/>热点资产查询加速]
    
    %% 应用层
    H --> I1[BI工具（Metabase）<br/>离线报表分析]
    H --> I2[轻量数据看板<br/>实时指标监控]
    
    %% 运维监控层
    C --> J[Prometheus+Grafana<br/>任务/存储/数据库监控]
    E --> J
    G --> J
    
    %% 样式标注
    style C fill:#f8f8ff,stroke:#ff6347,stroke-width:1.5px
    style E fill:#f5fafe,stroke:#32cd32,stroke-width:1.5px
    style G fill:#f5fafe,stroke:#ffd700,stroke-width:1.5px
```


### 二、中大型架构流程图（PB级离线+10万条/秒实时）

![数据湖架构图](/document/design/lake_02.png) *(注：请将架构图文件放入 `docs/images/` 目录下)*

```mermaid
flowchart LR
    %% 数据来源层
    A1[离线数据源<br/>HDFS/MySQL集群/FTP集群] --> B1[Spark Batch<br/>离线ETL+动态分区裁剪]
    A2[实时数据源<br/>Kafka集群（3副本）<br/>5节点高可用] --> B2[Spark Structured Streaming<br/>流处理优化（背压+状态管理）]
    
    %% 计算层（4台机器）
    B1 --> C[Spark on YARN集群<br/>2 Master（HA）+2 Worker<br/>动态资源调度+队列隔离]
    B2 --> C
    C --> D[Iceberg高级特性<br/>merge-on-read+时间旅行+TTL管理]
    
    %% 存储层（6台机器）
    D --> E[MinIO集群<br/>6节点+6+3纠删码<br/>热/温数据分离存储]
    E --> F[Iceberg元数据集群<br/>Hive Metastore（主从）+元数据缓存]
    E --> G[MinIO低频存储<br/>冷数据归档（成本优化）]
    
    %% 数据资产层（2台机器）
    F --> H[PostgreSQL主从架构<br/>1主1从+读写分离<br/>分区表优化]
    H --> I[Redis集群<br/>分布式缓存<br/>资产权限+查询结果缓存]
    
    %% 应用层
    I --> J1[BI工具（Superset）<br/>复杂离线分析]
    I --> J2[专业数据看板<br/>实时告警+钻取分析]
    I --> J3[API服务<br/>业务系统资产调用]
    
    %% 运维监控层
    C --> K[Prometheus+AlertManager<br/>异常告警+监控大屏]
    E --> K
    H --> K
    F --> K
    
    %% 样式标注
    style C fill:#f8f8ff,stroke:#ff6347,stroke-width:1.5px
    style E fill:#f5fafe,stroke:#32cd32,stroke-width:1.5px
    style H fill:#f5fafe,stroke:#ffd700,stroke-width:1.5px
```


### 三、超大型架构流程图（10PB+离线+50万条/秒实时）

![数据湖架构图](/document/design/lake_03.png) *(注：请将架构图文件放入 `docs/images/` 目录下)*

```mermaid
flowchart LR
    %% 数据来源层
    A1[离线数据源<br/>多区域业务库/HDFS联邦] --> B1[Spark Batch<br/>离线并行计算（分区域任务）]
    A2[实时数据源<br/>Kafka集群（3副本）<br/>10节点+分区动态扩容] --> B2[Spark Structured Streaming<br/>流处理集群（多Worker节点+状态后端优化）]
    
    %% 计算层（6+台机器）
    B1 --> C[Spark on YARN集群<br/>3 Master（HA）+3+ Worker<br/>多租户资源隔离+队列优先级]
    B2 --> C
    C --> D[Iceberg企业级优化<br/>分区进化+元数据异步提交+小文件合并服务]
    
    %% 存储层（12+台机器）
    D --> E[MinIO分布式集群<br/>12节点+10+2纠删码<br/>跨区域复制+存储加密]
    E --> F[Iceberg元数据服务<br/>Hive Metastore集群+ETCD（高可用）]
    E --> G[对象存储网关<br/>冷数据迁移至公有云（如S3）]
    
    %% 数据资产层（3+台机器）
    F --> H[Greenplum集群<br/>4节点MPP架构<br/>复杂资产分析+聚合计算]
    H --> I[PostgreSQL集群<br/>主从+分表分库<br/>资产元数据存储+权限管理]
    I --> J[Redis Cluster<br/>分片缓存<br/>热点资产+查询计划缓存]
    
    %% 应用层
    J --> K1[BI工具（Tableau）<br/>企业级离线分析]
    J --> K2[实时监控平台<br/>秒级延迟+大屏展示]
    J --> K3[数据服务平台<br/>资产API网关+限流+熔断]
    J --> K4[AI训练平台<br/>读取Iceberg数据训练]
    
    %% 运维监控层
    C --> L[Prometheus联邦+Grafana<br/>全链路监控+任务诊断]
    E --> L
    H --> L
    I --> L
    F --> M[数据治理平台<br/>血缘管理+质量监控+资产标签]
    
    %% 样式标注
    style C fill:#f8f8ff,stroke:#ff6347,stroke-width:1.5px
    style E fill:#f5fafe,stroke:#32cd32,stroke-width:1.5px
    style H fill:#f5fafe,stroke:#ffd700,stroke-width:1.5px
    style M fill:#fff0f5,stroke:#9370db,stroke-width:1.5px
```


### 核心调整说明（仅Spark流批一体）
1. **计算层强化Spark能力**：
    - 中小型用`Spark Standalone`，中大型/超大型升级为`Spark on YARN`（支持动态资源调度和高可用）。
    - 实时处理依赖`Spark Structured Streaming`的高级特性：背压机制、状态管理（ RocksDB 状态后端）、Exactly-Once语义，无需引入Flink。

2. **存储与资产层适配**：
    - 随数据量增长，MinIO从3节点扩展到12+节点，引入纠删码和冷热分离；Iceberg元数据从单机Rest Catalog升级为Hive Metastore集群。
    - 资产层从单PostgreSQL逐步升级为主从架构→分表分库→结合Greenplum（支撑复杂分析），满足不同规模的查询需求。

3. **运维与治理增强**：
    - 超大型架构增加数据治理平台，管理资产血缘、质量和标签，适配企业级数据资产管理需求。
